# Rockchip ä¸‰å¤§æ‰“åŒ…å·¥å…·æ ¸å¿ƒæ€æƒ³å¯¹æ¯”

## ä¸€ã€è®¾è®¡å“²å­¦ï¼šä¸ºä»€ä¹ˆéœ€è¦æ‰“åŒ…å·¥å…·ï¼Ÿ

### æ ¸å¿ƒé—®é¢˜
ç¼–è¯‘å™¨ç”Ÿæˆçš„åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆ`.bin`ï¼‰**æ— æ³•ç›´æ¥è¢« Rockchip BootROM è¯†åˆ«å’ŒåŠ è½½**ã€‚

### æ ¹æœ¬åŸå› 
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BootROM å›ºåŒ–åœ¨èŠ¯ç‰‡ä¸­ï¼Œåªæœ‰ 32KB SRAM               â”‚
â”‚  â†“                                                   â”‚
â”‚  1. æ— æ³•è§£æå¤æ‚çš„ ELF æ–‡ä»¶æ ¼å¼ï¼ˆéœ€è¦å‡ åƒè¡Œä»£ç ï¼‰  â”‚
â”‚  2. éœ€è¦å¿«é€Ÿè¯†åˆ«é•œåƒç±»å‹ï¼ˆé€šè¿‡é­”æ•°ï¼‰               â”‚
â”‚  3. éœ€è¦å®Œæ•´æ€§æ ¡éªŒï¼ˆCRC/SHAï¼‰é˜²æ­¢ Flash æŸå       â”‚
â”‚  4. éœ€è¦å®‰å…¨å¯åŠ¨æ”¯æŒï¼ˆRSA ç­¾åéªŒè¯ï¼‰               â”‚
â”‚  5. éœ€è¦å¤šå‰¯æœ¬å®¹é”™æœºåˆ¶ï¼ˆFlash å¯èƒ½æœ‰åå—ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£å†³æ–¹æ¡ˆ
**ç»™åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶æ·»åŠ  Rockchip ä¸“ç”¨å¤´éƒ¨** â†’ è®© BootROM èƒ½å¤Ÿï¼š
- **è¯†åˆ«**ï¼šé€šè¿‡é­”æ•°åˆ¤æ–­æ˜¯ Loader / U-Boot / Trust
- **æ ¡éªŒ**ï¼šé€šè¿‡ CRC/SHA éªŒè¯æ•°æ®å®Œæ•´æ€§
- **å®šä½**ï¼šé€šè¿‡åç§»é‡æ‰¾åˆ°å„ä¸ªç»„ä»¶çš„ä½ç½®
- **åŠ è½½**ï¼šå°†æ•°æ®å¤åˆ¶åˆ°æŒ‡å®šçš„ DRAM åœ°å€
- **è·³è½¬**ï¼šæ‰§è¡Œä»£ç 

---

## äºŒã€ä¸‰ä¸ªå·¥å…·çš„æ€æƒ³ç²¾é«“

### 1ï¸âƒ£ boot_mergerï¼šå¤šç»„ä»¶æ‹¼è£…å¤§å¸ˆ

**æ ¸å¿ƒæ€æƒ³**ï¼š**åƒä¹é«˜ä¸€æ ·æ‹¼æ¥å¤šä¸ªç‹¬ç«‹ç»„ä»¶**

```
è®¾è®¡å“²å­¦ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  BootROM å¯åŠ¨æµç¨‹éœ€è¦ä¸¤ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼š   â”‚
â”‚  1. DDR Initï¼ˆCODE471ï¼‰- åˆå§‹åŒ–å†…å­˜      â”‚
â”‚  2. Miniloaderï¼ˆFlashBootï¼‰- æœ€å°å¼•å¯¼å™¨  â”‚
â”‚                                          â”‚
â”‚  boot_merger çš„ä»»åŠ¡ï¼š                    â”‚
â”‚  å°†è¿™äº›ç¢ç‰‡åŒ–çš„ç»„ä»¶åˆå¹¶æˆä¸€ä¸ªæ–‡ä»¶        â”‚
â”‚  å¹¶ç”Ÿæˆ"å¯¼èˆªåœ°å›¾"ï¼ˆEntry è¡¨ï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- **è¾“å…¥**ï¼šå¤šä¸ªç‹¬ç«‹çš„ `.bin` æ–‡ä»¶ï¼ˆå¯ä»¥æ¥è‡ªä¸åŒæ¥æºï¼‰
- **è¾“å‡º**ï¼šå•ä¸ª `loader.bin` æ–‡ä»¶
- **æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š`rk_boot_entry` æ•°ç»„ï¼ˆè®°å½•æ¯ä¸ªç»„ä»¶çš„åç§»å’Œå¤§å°ï¼‰
- **ç‰¹æ®ŠåŠŸèƒ½**ï¼šæ”¯æŒ RC4 åŠ å¯†ï¼ˆå¯é€‰ï¼‰

**ç±»æ¯”**ï¼š
> boot_merger å°±åƒä¸€ä¸ª**æ‰“åŒ…å¿«é€’çš„å·¥äºº**ï¼š
> - æŠŠå¤šä¸ªåŒ…è£¹ï¼ˆDDR init, Miniloaderï¼‰è£…è¿›ä¸€ä¸ªå¤§ç®±å­
> - è´´ä¸Šæ ‡ç­¾ï¼ˆEntry è¡¨ï¼‰æ³¨æ˜æ¯ä¸ªåŒ…è£¹çš„ä½ç½®
> - ç›–ä¸Šå°æ¡ï¼ˆCRC32 æ ¡éªŒï¼‰

**æºç å…³é”®å‡½æ•°**ï¼š
- `boot_merger.c:1286` `mergeBoot()` - ä¸»åˆå¹¶é€»è¾‘
- `boot_merger.c:1019` `saveEntry()` - ä¿å­˜ Entry å…ƒæ•°æ®
- `boot_merger.c:932` `writeFile()` - å†™å…¥ç»„ä»¶æ•°æ®

---

### 2ï¸âƒ£ trust_mergerï¼šELF æ®µæå–ä¸“å®¶

**æ ¸å¿ƒæ€æƒ³**ï¼š**ä» ELF æ–‡ä»¶ä¸­æå–å¤šä¸ªä¸è¿ç»­çš„å†…å­˜æ®µ**

```
è®¾è®¡å“²å­¦ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ARM Trusted Firmware (BL31) ç¼–è¯‘åæ˜¯ ELF æ–‡ä»¶   â”‚
â”‚  ELF æ–‡ä»¶ç‰¹ç‚¹ï¼š                                   â”‚
â”‚  - ä»£ç æ®µåœ¨ 0x00010000                           â”‚
â”‚  - æ•°æ®æ®µåœ¨ 0x0001b000                           â”‚
â”‚  - SRAM æ®µåœ¨ 0xff8c0000ï¼ˆä¸è¿ç»­ï¼ï¼‰              â”‚
â”‚                                                   â”‚
â”‚  å¦‚æœç›´æ¥ç”¨ objcopy è½¬ .binï¼š                     â”‚
â”‚  âœ— ä¼šä¸¢å¤±æ®µçš„åœ°å€ä¿¡æ¯                            â”‚
â”‚  âœ— æ— æ³•å¤„ç†ä¸è¿ç»­çš„å†…å­˜æ®µ                        â”‚
â”‚                                                   â”‚
â”‚  trust_merger çš„ä»»åŠ¡ï¼š                            â”‚
â”‚  1. è§£æ ELF çš„ Program Header Table             â”‚
â”‚  2. æå–æ‰€æœ‰ PT_LOAD æ®µ                          â”‚
â”‚  3. ä¿ç•™æ¯ä¸ªæ®µçš„è™šæ‹Ÿåœ°å€ï¼ˆLoadAddrï¼‰             â”‚
â”‚  4. ä¸ºæ¯ä¸ªæ®µè®¡ç®— SHA256 å“ˆå¸Œï¼ˆå®‰å…¨å¯åŠ¨ï¼‰         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- **è¾“å…¥**ï¼šELF æ–‡ä»¶ï¼ˆbl31.elfï¼‰æˆ– BIN æ–‡ä»¶ï¼ˆbl32.binï¼‰
- **è¾“å‡º**ï¼š`trust.img` æ–‡ä»¶
- **æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼šåŒå±‚è¡¨
  - `COMPONENT_DATA`ï¼šè¿è¡Œæ—¶ä¿¡æ¯ï¼ˆLoadAddr + SHA256 å“ˆå¸Œï¼‰
  - `TRUST_COMPONENT`ï¼šå­˜å‚¨ä¿¡æ¯ï¼ˆComponentID + StorageAddr + ImageSizeï¼‰
- **ç‰¹æ®ŠåŠŸèƒ½**ï¼šELF å¤šæ®µè§£æï¼ˆ`filter_elf()`ï¼‰

**ç±»æ¯”**ï¼š
> trust_merger å°±åƒä¸€ä¸ª**å»ºç­‘æ‹†è¿ä¸“å®¶**ï¼š
> - ä»å®Œæ•´çš„ ELF å¤§æ¥¼ä¸­æ‹†å‡ºå„ä¸ªæ¥¼å±‚ï¼ˆPT_LOAD æ®µï¼‰
> - è®°å½•æ¯ä¸ªæ¥¼å±‚åŸæ¥çš„ä½ç½®ï¼ˆVirtAddrï¼‰
> - ç»™æ¯ä¸ªæ¥¼å±‚æ‹ç…§å­˜æ¡£ï¼ˆSHA256 å“ˆå¸Œï¼‰
> - é‡æ–°æ‰“åŒ…æˆå¯è¿è¾“çš„ç»„ä»¶

**æºç å…³é”®å‡½æ•°**ï¼š
- `trust_merger.c:682` `mergetrust()` - ä¸»åˆå¹¶é€»è¾‘
- `trust_merger.c:508` `filter_elf()` - ELF æ®µæå–ï¼ˆ**æ ¸å¿ƒï¼**ï¼‰
- `trust_merger.c:631` `bl3xHash256()` - SHA256 è®¡ç®—

---

### 3ï¸âƒ£ loaderimageï¼šå•æ®µç®€å•å°è£…å™¨

**æ ¸å¿ƒæ€æƒ³**ï¼š**ç»™å•ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ç©¿ä¸Šæ ‡å‡†å¤–å¥—**

```
è®¾è®¡å“²å­¦ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  U-Boot ç¼–è¯‘åæ˜¯å•ä¸ªè¿ç»­çš„ u-boot.bin    â”‚
â”‚  ç‰¹ç‚¹ï¼š                                   â”‚
â”‚  - åªæœ‰ä¸€ä¸ªä»£ç æ®µ                        â”‚
â”‚  - ä» 0x00200000 å¼€å§‹åŠ è½½                â”‚
â”‚  - ä¸éœ€è¦å¤æ‚çš„ Entry è¡¨                 â”‚
â”‚                                          â”‚
â”‚  loaderimage çš„ä»»åŠ¡ï¼š                    â”‚
â”‚  ç›´æ¥åœ¨ bin æ–‡ä»¶å‰é¢åŠ ä¸€ä¸ª 2048 å­—èŠ‚å¤´éƒ¨ â”‚
â”‚  å¤´éƒ¨åŒ…å«æ‰€æœ‰éœ€è¦çš„ä¿¡æ¯ï¼ˆåœ°å€ã€å¤§å°ï¼‰    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‰¹æ€§**ï¼š
- **è¾“å…¥**ï¼šå•ä¸ª `.bin` æ–‡ä»¶ï¼ˆu-boot.bin æˆ– trust.binï¼‰
- **è¾“å‡º**ï¼š`uboot.img` æˆ– `trust.img`
- **æ ¸å¿ƒæ•°æ®ç»“æ„**ï¼š`second_loader_hdr`ï¼ˆ2048 å­—èŠ‚ï¼Œæ‰€æœ‰ä¿¡æ¯åµŒå…¥å¤´éƒ¨ï¼‰
- **ç‰¹æ®ŠåŠŸèƒ½**ï¼šCRC32 + SHA256 åŒé‡æ ¡éªŒ

**ç±»æ¯”**ï¼š
> loaderimage å°±åƒä¸€ä¸ª**é‚®å±€è´´æ ‡ç­¾å‘˜**ï¼š
> - ç»™ä¿¡å°ï¼ˆu-boot.binï¼‰è´´ä¸Šé‚®ç¥¨å’Œåœ°å€æ ‡ç­¾ï¼ˆå¤´éƒ¨ï¼‰
> - ç§°é‡å¹¶è®°å½•é‡é‡ï¼ˆloader_load_sizeï¼‰
> - ç›–é‚®æˆ³ï¼ˆCRC32 + SHA256ï¼‰
> - ç›´æ¥å¯„å‡ºï¼ˆä¸éœ€è¦å¤æ‚çš„åˆ†ç±»ï¼‰

**æºç å…³é”®å‡½æ•°**ï¼š
- `loaderimage.c:151` `main()` - ä¸»æµç¨‹ï¼ˆéå¸¸ç›´æ¥ï¼‰
- `loaderimage.c:324` CRC32 è®¡ç®—
- `loaderimage.c:353` SHA256 è®¡ç®—

---

## ä¸‰ã€åŠŸèƒ½å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | boot_merger | trust_merger | loaderimage |
|------|-------------|--------------|-------------|
| **å¤æ‚åº¦** | â­â­â­ ä¸­ç­‰ | â­â­â­â­â­ æœ€å¤æ‚ | â­ æœ€ç®€å• |
| **è¾“å…¥æ–‡ä»¶** | å¤šä¸ª BIN æ–‡ä»¶ | ELF + BIN æ··åˆ | å•ä¸ª BIN æ–‡ä»¶ |
| **è¾“å‡ºæ–‡ä»¶** | loader.bin | trust.img | uboot.img / trust.img |
| **é­”æ•°** | "BOOT" (0x544F4F42) | "TRUS" | "LOADER" / "TOS" |
| **å¤´éƒ¨å¤§å°** | 102 å­—èŠ‚ | 2048 å­—èŠ‚ | 2048 å­—èŠ‚ |
| **Entry è¡¨** | âœ… rk_boot_entry[] | âœ… åŒå±‚è¡¨ï¼ˆCOMPONENT_DATA + TRUST_COMPONENTï¼‰ | âŒ æ— ç‹¬ç«‹è¡¨ï¼ˆä¿¡æ¯åµŒå…¥å¤´éƒ¨ï¼‰ |
| **ELF æ”¯æŒ** | âŒ ä¸æ”¯æŒ | âœ… **æ”¯æŒï¼ˆæ ¸å¿ƒç‰¹æ€§ï¼‰** | âŒ ä¸æ”¯æŒ |
| **å¤šæ®µæ”¯æŒ** | âœ… æ”¯æŒå¤šä¸ª Entry | âœ… æ”¯æŒ ELF å¤šæ®µ | âŒ å•æ®µ |
| **æ ¡éªŒç®—æ³•** | CRC32 | SHA256 | CRC32 + SHA256 |
| **åŠ å¯†åŠŸèƒ½** | âœ… RC4 åŠ å¯†ï¼ˆå¯é€‰ï¼‰ | âŒ æ—  | âŒ æ—  |
| **å¤‡ä»½å‰¯æœ¬** | 1 ä¸ª | 2 ä¸ªï¼ˆé»˜è®¤ï¼‰ | 4 ä¸ªï¼ˆU-Bootï¼‰<br>2 ä¸ªï¼ˆNVMEï¼‰ |
| **å¯¹é½å•ä½** | 2048 å­—èŠ‚ï¼ˆEntryï¼‰<br>512 å­—èŠ‚ï¼ˆLoaderåˆ†å—ï¼‰ | 512 å­—èŠ‚ | 512 å­—èŠ‚ |
| **é…ç½®æ–¹å¼** | INI æ–‡ä»¶ æˆ– å‘½ä»¤è¡Œ | INI æ–‡ä»¶ | å‘½ä»¤è¡Œå‚æ•° |
| **è§£åŒ…åŠŸèƒ½** | âœ… `--unpack` | âœ… `--unpack` | âœ… `--unpack` |
| **ä¿¡æ¯æŸ¥è¯¢** | âŒ æ—  | âŒ æ—  | âœ… `--info` |
| **åº”ç”¨åœºæ™¯** | BootROM â†’ DDR Init â†’ Miniloader | U-Boot â†’ ATF â†’ OP-TEE | Miniloader â†’ U-Boot |

---

## å››ã€æ•°æ®ç»“æ„å¯¹æ¯”

### 1ï¸âƒ£ boot_merger çš„æ•°æ®ç»“æ„ï¼ˆç´§å‡‘å‹ï¼‰

```c
// å¤´éƒ¨ï¼š102 å­—èŠ‚ï¼ˆæç®€è®¾è®¡ï¼‰
rk_boot_header {
    uint32_t tag;           // "BOOT"
    uint32_t chipType;      // RK3399 = 0x33393933
    uint8_t loaderNum;      // Entry æ•°é‡
    uint32_t loaderOffset;  // Entry è¡¨åç§»
    // ...
}

// Entry è¡¨ï¼š57 å­—èŠ‚/Entryï¼ˆåŒ…å«æ–‡ä»¶åï¼‰
rk_boot_entry {
    uint16_t name[20];      // Unicode åç§°ï¼ˆ"FlashData"ï¼‰
    uint32_t dataOffset;    // æ‰‡åŒºå·
    uint32_t dataSize;      // å­—èŠ‚æ•°
    // ...
}

å®Œæ•´å¸ƒå±€ï¼š
[102B Header] [57B EntryÃ—N] [å¡«å……è‡³2KB] [æ•°æ®å—1] [æ•°æ®å—2] ... [CRC32]
```

### 2ï¸âƒ£ trust_merger çš„æ•°æ®ç»“æ„ï¼ˆåŒå±‚è¡¨è®¾è®¡ï¼‰

```c
// å¤´éƒ¨ï¼š2048 å­—èŠ‚ï¼ˆé¢„ç•™ç­¾åç©ºé—´ï¼‰
TRUST_HEADER {
    uint8_t tag[4];         // "TRUS"
    uint32_t size;          // é«˜16ä½=ç»„ä»¶æ•°, ä½16ä½=ç­¾ååç§»/4
    uint32_t flags;         // SHAæ¨¡å¼ + RSAæ¨¡å¼
    uint8_t rsa_n[256];     // RSA å…¬é’¥
    // ...
}

// ç¬¬ä¸€å±‚è¡¨ï¼šè¿è¡Œæ—¶ä¿¡æ¯ï¼ˆ40 å­—èŠ‚/ç»„ä»¶ï¼‰
COMPONENT_DATA {
    uint32_t LoadAddr;      // åŠ è½½åœ°å€ï¼ˆä» ELF VirtAddr æå–ï¼‰
    uint32_t HashData[8];   // SHA256 å“ˆå¸Œ
}

// ç¬¬äºŒå±‚è¡¨ï¼šå­˜å‚¨ä¿¡æ¯ï¼ˆ12 å­—èŠ‚/ç»„ä»¶ï¼‰
TRUST_COMPONENT {
    uint32_t ComponentID;   // 'BL31' / 'BL32'
    uint32_t StorageAddr;   // æ‰‡åŒºå·ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
    uint32_t ImageSize;     // æ‰‡åŒºæ•°
}

å®Œæ•´å¸ƒå±€ï¼š
[2KB Header] [40B DataÃ—N] [768B ç­¾å] [12B InfoÃ—N] [æ®µ1] [æ®µ2] ... [å‰¯æœ¬1] [å‰¯æœ¬2]
```

### 3ï¸âƒ£ loaderimage çš„æ•°æ®ç»“æ„ï¼ˆä¸€ä½“åŒ–è®¾è®¡ï¼‰

```c
// å¤´éƒ¨ï¼š2048 å­—èŠ‚ï¼ˆæ‰€æœ‰ä¿¡æ¯åµŒå…¥ï¼‰
second_loader_hdr {
    uint8_t magic[8];       // "LOADER  " æˆ– "TOS     "
    uint32_t loader_load_addr;  // åŠ è½½åœ°å€
    uint32_t loader_load_size;  // æ•°æ®å¤§å°
    uint32_t crc32;         // CRC32 æ ¡éªŒ
    uint8_t hash[32];       // SHA256 å“ˆå¸Œ
    uint32_t signTag;       // 0x4E474953 ("SIGN")
    uint8_t rsaHash[256];   // RSA ç­¾å
    // ...
}

å®Œæ•´å¸ƒå±€ï¼š
[2KB Header] [æ•°æ®] [å¡«å……è‡³1MB] Ã— 4ï¼ˆå‰¯æœ¬ï¼‰
```

---

## äº”ã€æ ¸å¿ƒæ€æƒ³æ€»ç»“

### ğŸ¯ è®¾è®¡å“²å­¦çš„å…±åŒç‚¹

ä¸‰ä¸ªå·¥å…·éƒ½éµå¾ª**"å…ƒæ•°æ® + æ•°æ®åˆ†ç¦»"**çš„è®¾è®¡æ¨¡å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å…ƒæ•°æ®åŒºï¼ˆHeader + Tableï¼‰             â”‚
â”‚  â†“                                      â”‚
â”‚  å‘Šè¯‰ BootROMï¼š                         â”‚
â”‚  - è¿™æ˜¯ä»€ä¹ˆé•œåƒï¼Ÿï¼ˆé­”æ•°ï¼‰               â”‚
â”‚  - æœ‰å“ªäº›ç»„ä»¶ï¼Ÿï¼ˆEntry/Component è¡¨ï¼‰   â”‚
â”‚  - æ•°æ®åœ¨å“ªé‡Œï¼Ÿï¼ˆOffsetï¼‰               â”‚
â”‚  - æ€ä¹ˆåŠ è½½ï¼Ÿï¼ˆLoadAddrï¼‰               â”‚
â”‚  - æ•°æ®å¯¹å—ï¼Ÿï¼ˆCRC/SHAï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ•°æ®åŒºï¼ˆå¯¹é½çš„äºŒè¿›åˆ¶å—ï¼‰               â”‚
â”‚  - DDR init ä»£ç                         â”‚
â”‚  - Miniloader ä»£ç                       â”‚
â”‚  - U-Boot ä»£ç                           â”‚
â”‚  - ATF/OP-TEE ä»£ç                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”‘ å…³é”®å·®å¼‚ç‚¹

| å·¥å…· | æ ¸å¿ƒæŒ‘æˆ˜ | è§£å†³æ–¹æ¡ˆ | å…³é”®åˆ›æ–° |
|------|----------|----------|----------|
| **boot_merger** | å¤šä¸ªç‹¬ç«‹æ–‡ä»¶æ‹¼æ¥ | Entry è¡¨ + æ‰‡åŒºå¯»å€ | RC4 åˆ†å—åŠ å¯† |
| **trust_merger** | ELF å¤šæ®µä¸è¿ç»­ | åŒå±‚è¡¨ + ELF è§£æ | **ä¿ç•™è™šæ‹Ÿåœ°å€** |
| **loaderimage** | å•æ–‡ä»¶ç®€å•å°è£… | ä¸€ä½“åŒ–å¤´éƒ¨ | CRC + SHA åŒé‡æ ¡éªŒ |

---

## å…­ã€ä½¿ç”¨åœºæ™¯å’Œå¯åŠ¨æµç¨‹

### å®Œæ•´çš„ RK3399 å¯åŠ¨é“¾

```
å¯åŠ¨é˜¶æ®µ 0ï¼šBootROMï¼ˆå›ºåŒ–åœ¨èŠ¯ç‰‡ï¼‰
  â†“ è¯»å– loader.bin (boot_merger ç”Ÿæˆ)
  â”œâ”€ éªŒè¯ "BOOT" é­”æ•°
  â”œâ”€ è¯»å– Entry è¡¨
  â”œâ”€ åŠ è½½ FlashData (DDR init)
  â””â”€ æ‰§è¡Œ DDR åˆå§‹åŒ–

å¯åŠ¨é˜¶æ®µ 1ï¼šMiniloader (FlashData æ‰§è¡Œå®Œæ¯•)
  â†“ è¯»å– uboot.img (loaderimage ç”Ÿæˆ)
  â”œâ”€ éªŒè¯ "LOADER" é­”æ•°
  â”œâ”€ æ ¡éªŒ CRC32 + SHA256
  â”œâ”€ åŠ è½½åˆ° 0x00200000
  â””â”€ è·³è½¬åˆ° U-Boot

å¯åŠ¨é˜¶æ®µ 2ï¼šU-Boot
  â†“ è¯»å– trust.img (trust_merger ç”Ÿæˆ)
  â”œâ”€ éªŒè¯ "TRUS" é­”æ•°
  â”œâ”€ è¯»å– COMPONENT_DATA è¡¨
  â”œâ”€ éªŒè¯ SHA256 å“ˆå¸Œ
  â”œâ”€ åŠ è½½ BL31 åˆ° 0x00010000
  â”œâ”€ åŠ è½½ BL32 åˆ° 0x08400000
  â””â”€ è·³è½¬åˆ° BL31 (ARM Trusted Firmware)

å¯åŠ¨é˜¶æ®µ 3ï¼šATF + OP-TEE + Linux
  â””â”€ æœ€ç»ˆå¯åŠ¨ Linux Kernel
```

### å·¥å…·ä½¿ç”¨æ—¶æœº

```bash
# 1. ç¼–è¯‘ U-Boot å
make CROSS_COMPILE=aarch64-linux-gnu- rk3399_defconfig
make CROSS_COMPILE=aarch64-linux-gnu-
# â†“ ç”Ÿæˆ u-boot.bin
./tools/loaderimage --pack --uboot u-boot.bin uboot.img 0x200000
# â†“ ç”Ÿæˆ uboot.img (loaderimage)

# 2. ç¼–è¯‘ ATF å
cd arm-trusted-firmware
make PLAT=rk3399 bl31
# â†“ ç”Ÿæˆ bl31.elf
../trust_merger RK3399TRUST.ini
# â†“ ç”Ÿæˆ trust.img (trust_merger)

# 3. æ‰“åŒ… Loader
./boot_merger RKBOOT/RK3399MINIALL.ini
# â†“ ç”Ÿæˆ loader.bin (boot_merger)
```

---

## ä¸ƒã€å¿«é€Ÿè®°å¿†å£è¯€

### ä¸‰å¥è¯æ€»ç»“

1. **boot_merger**ï¼š**"å¤šåˆä¸€æ‰“åŒ…æœº"** - æŠŠç¢ç‰‡åŒ–çš„å¯åŠ¨ç»„ä»¶æ‹¼æˆä¸€ä¸ªåŒ…è£¹
2. **trust_merger**ï¼š**"ELF æ®µæ¬è¿å·¥"** - ä» ELF æ–‡ä»¶ä¸­æ‹†å‡ºä¸è¿ç»­çš„å†…å­˜æ®µ
3. **loaderimage**ï¼š**"å•ä»¶è´´æ ‡ç­¾å™¨"** - ç»™å•ä¸ª bin æ–‡ä»¶åŠ ä¸Šæ ‡å‡†å¤´éƒ¨

### è®°å¿†æŠ€å·§

```
é—®ï¼šä»€ä¹ˆæ—¶å€™ç”¨ boot_mergerï¼Ÿ
ç­”ï¼šå½“ä½ æœ‰å¤šä¸ªç‹¬ç«‹çš„ .bin æ–‡ä»¶éœ€è¦æ‹¼æ¥æ—¶ï¼ˆDDR + Miniloaderï¼‰

é—®ï¼šä»€ä¹ˆæ—¶å€™ç”¨ trust_mergerï¼Ÿ
ç­”ï¼šå½“ä½ æœ‰ ELF æ–‡ä»¶ä¸”éœ€è¦ä¿ç•™å¤šä¸ªæ®µçš„åœ°å€ä¿¡æ¯æ—¶ï¼ˆBL31.elfï¼‰

é—®ï¼šä»€ä¹ˆæ—¶å€™ç”¨ loaderimageï¼Ÿ
ç­”ï¼šå½“ä½ åªæœ‰å•ä¸ª .bin æ–‡ä»¶ä¸”åªéœ€åŠ ä¸ªå¤´éƒ¨æ—¶ï¼ˆu-boot.binï¼‰
```

### åˆ¤æ–­æµç¨‹å›¾

```
è¾“å…¥æ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ
  â”œâ”€ å¤šä¸ª BIN æ–‡ä»¶ â†’ boot_merger
  â”œâ”€ ELF æ–‡ä»¶ â†’ trust_merger
  â””â”€ å•ä¸ª BIN æ–‡ä»¶ â†’ loaderimage

éœ€è¦ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ
  â”œâ”€ ELF å¤šæ®µè§£æ â†’ trust_merger âœ…ï¼ˆå”¯ä¸€æ”¯æŒï¼‰
  â”œâ”€ RC4 åŠ å¯† â†’ boot_merger âœ…ï¼ˆå”¯ä¸€æ”¯æŒï¼‰
  â”œâ”€ ä¿¡æ¯æŸ¥è¯¢ â†’ loaderimage âœ…ï¼ˆ--info å‚æ•°ï¼‰
  â””â”€ æœ€ç®€å•çš„å°è£… â†’ loaderimage
```

---

## å…«ã€å…³é”®ä»£ç å¯¼èˆª

å¦‚æœä½ æƒ³æ·±å…¥ç ”ç©¶ï¼Œè¿™äº›æ˜¯æœ€æ ¸å¿ƒçš„å‡½æ•°ï¼š

### boot_merger.c
```c
è¡Œ 1286ï¼šmergeBoot()      // ä¸»åˆå¹¶é€»è¾‘ï¼ˆå…¥å£å‡½æ•°ï¼‰
è¡Œ 1178ï¼šgetBoothdr()     // æ„å»º rk_boot_header
è¡Œ 1019ï¼šsaveEntry()      // ä¿å­˜ Entry å…ƒæ•°æ®
è¡Œ  932ï¼šwriteFile()      // å†™å…¥ç»„ä»¶æ•°æ®ï¼ˆæ”¯æŒ RC4 åŠ å¯†ï¼‰
è¡Œ  102ï¼šCRC_32()         // CRC32 è®¡ç®—
è¡Œ  121ï¼šP_RC4()          // RC4 åŠ å¯†ç®—æ³•
```

### trust_merger.c
```c
è¡Œ  682ï¼šmergetrust()     // ä¸»åˆå¹¶é€»è¾‘ï¼ˆå…¥å£å‡½æ•°ï¼‰
è¡Œ  508ï¼šfilter_elf()     // â˜…æ ¸å¿ƒâ˜… ELF æ®µæå–
è¡Œ  631ï¼šbl3xHash256()    // SHA256 å“ˆå¸Œè®¡ç®—
è¡Œ  183ï¼šparseBL3x()      // è§£æ BL3x é…ç½®
```

### loaderimage.c
```c
è¡Œ  151ï¼šmain()           // ä¸»æµç¨‹ï¼ˆéå¸¸ç›´æ¥ï¼Œé€‚åˆå…¥é—¨ï¼‰
è¡Œ  261ï¼šMODE_PACK        // æ‰“åŒ…æ¨¡å¼
è¡Œ  382ï¼šMODE_UNPACK      // è§£åŒ…æ¨¡å¼
è¡Œ  426ï¼šMODE_INFO        // ä¿¡æ¯æŸ¥è¯¢æ¨¡å¼
```

---

## ä¹ã€å­¦ä¹ å»ºè®®

### æ¨èé˜…è¯»é¡ºåº

1. **ç¬¬ä¸€æ­¥**ï¼šå…ˆè¯» `loaderimage.c`
   - æœ€ç®€å•ï¼Œåªæœ‰ 460 è¡Œ
   - äº†è§£"å¤´éƒ¨ + æ•°æ®"çš„åŸºæœ¬æ¨¡å¼

2. **ç¬¬äºŒæ­¥**ï¼šè¯» `boot_merger.c`
   - ç†è§£ Entry è¡¨çš„è®¾è®¡
   - çœ‹æ‡‚ RC4 åŠ å¯†çš„å®ç°

3. **ç¬¬ä¸‰æ­¥**ï¼šè¯» `trust_merger.c`
   - é‡ç‚¹çœ‹ `filter_elf()` å‡½æ•°ï¼ˆè¡Œ 508ï¼‰
   - ç†è§£ä¸ºä»€ä¹ˆéœ€è¦åŒå±‚è¡¨ç»“æ„

### å¿«é€ŸéªŒè¯ç†è§£

è¿è¡Œè¿™äº›å‘½ä»¤éªŒè¯ä½ çš„ç†è§£ï¼š

```bash
# 1. æŸ¥çœ‹ loader.bin çš„å¤´éƒ¨
hexdump -C loader.bin | head -20
# åº”è¯¥çœ‹åˆ° "BOOT" é­”æ•°

# 2. æŸ¥çœ‹ trust.img çš„å¤´éƒ¨
hexdump -C trust.img | head -20
# åº”è¯¥çœ‹åˆ° "TRUS" é­”æ•°

# 3. è§£åŒ… uboot.img
./loaderimage --unpack uboot.img u-boot-extracted.bin
# æå–å‡ºåŸå§‹ u-boot.bin

# 4. æŸ¥çœ‹é•œåƒä¿¡æ¯
./loaderimage --info uboot.img
# æ˜¾ç¤ºåŠ è½½åœ°å€å’Œç‰ˆæœ¬å·
```

---

## åã€å¸¸è§è¯¯åŒºæ¾„æ¸…

### âŒ è¯¯åŒº 1ï¼štrust_merger å’Œ loaderimage åŠŸèƒ½é‡å¤ï¼Ÿ
**çœŸç›¸**ï¼šå®Œå…¨ä¸åŒï¼
- `trust_merger`ï¼šå¤„ç† **ELF å¤šæ®µ** â†’ ç”Ÿæˆ trust.img
- `loaderimage`ï¼šå¤„ç† **å•ä¸ª BIN** â†’ ä¹Ÿèƒ½ç”Ÿæˆ trust.img

å®ƒä»¬çš„**è¾“å…¥å’Œå¤„ç†æ–¹å¼å®Œå…¨ä¸åŒ**ï¼Œåªæ˜¯ç¢°å·§è¾“å‡ºæ–‡ä»¶åç›¸åŒã€‚

### âŒ è¯¯åŒº 2ï¼šå¯ä»¥ç”¨ objcopy æ›¿ä»£è¿™äº›å·¥å…·ï¼Ÿ
**çœŸç›¸**ï¼šä¸è¡Œï¼
- `objcopy -O binary` åªèƒ½è½¬æ¢**å•ä¸ªè¿ç»­æ®µ**
- æ— æ³•å¤„ç† ELF çš„**ä¸è¿ç»­å†…å­˜å¸ƒå±€**ï¼ˆå¦‚ SRAM æ®µï¼‰
- æ— æ³•æ·»åŠ  Rockchip ä¸“ç”¨å¤´éƒ¨ï¼ˆé­”æ•°ã€CRCã€SHAï¼‰

### âŒ è¯¯åŒº 3ï¼šå¤´éƒ¨åªæ˜¯è£…é¥°ï¼Œå¯ä»¥åˆ æ‰ï¼Ÿ
**çœŸç›¸**ï¼šç»å¯¹ä¸è¡Œï¼
- BootROM **å¼ºåˆ¶è¦æ±‚**æ£€æŸ¥é­”æ•°
- æ²¡æœ‰å¤´éƒ¨ = BootROM æ— æ³•è¯†åˆ« = ç³»ç»Ÿæ— æ³•å¯åŠ¨
- å¤´éƒ¨åŒ…å«å…³é”®ä¿¡æ¯ï¼ˆåŠ è½½åœ°å€ã€æ•°æ®å¤§å°ã€æ ¡éªŒå€¼ï¼‰

---

## æ€»ç»“ï¼šä¸€å¼ å›¾çœ‹æ‡‚ä¸‰å¤§å·¥å…·

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Rockchip å›ºä»¶æ‰“åŒ…å·¥å…·å…¨æ™¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                    ç¼–è¯‘å™¨è¾“å‡º
                        â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
   å¤šä¸ª BIN æ–‡ä»¶                    ELF æ–‡ä»¶              å•ä¸ª BIN æ–‡ä»¶
  (DDR + Miniloader)                (BL31.elf)            (u-boot.bin)
        â”‚                               â”‚                      â”‚
        â†“                               â†“                      â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ boot_    â”‚                    â”‚ trust_   â”‚          â”‚ loader   â”‚
  â”‚ merger   â”‚                    â”‚ merger   â”‚          â”‚ image    â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   Entryè¡¨+æ•°æ®                   åŒå±‚è¡¨+å¤šæ®µè§£æ        ä¸€ä½“åŒ–å¤´éƒ¨
        â”‚                               â”‚                      â”‚
        â†“                               â†“                      â†“
   loader.bin                       trust.img              uboot.img
  (BootROMåŠ è½½)                    (U-BootåŠ è½½)         (MiniloaderåŠ è½½)
        â”‚                               â”‚                      â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â†“
                 Rockchip å¯åŠ¨æµç¨‹
      BootROM â†’ DDR Init â†’ Miniloader â†’ U-Boot â†’ ATF â†’ Linux
```

ç°åœ¨ä½ åº”è¯¥å¯¹è¿™ä¸‰ä¸ªå·¥å…·æœ‰äº†æ¸…æ™°çš„è®¤çŸ¥æ¡†æ¶ï¼ğŸ‰
