# 镜像尺寸参数说明

## 问题：fixup_platform_configure 中的镜像尺寸是干什么用的？

在 `uboot/make.sh` 的 `fixup_platform_configure()` 函数中设置的镜像尺寸参数有两个主要作用：

---

## 1. 固件大小限制验证

### 位置
`uboot/make.sh:762-776` 的 `pack_uboot_image()` 函数

### 代码逻辑
```bash
# 从平台配置中提取最大 KB 数（第二个参数）
UBOOT_MAX_KB=`echo $PLATFORM_UBOOT_IMG_SIZE | awk '{print strtonum($2)}'`
# 减去头部大小（2KB），转换为字节数
UBOOT_MAX_KB=$(((UBOOT_MAX_KB-HEAD_KB)*1024))

# 检查 u-boot.bin 是否超过大小限制
if [ $UBOOT_KB -gt $UBOOT_MAX_KB ]; then
    echo "ERROR: pack uboot failed! u-boot.bin actual: $UBOOT_KB bytes, max limit: $UBOOT_MAX_KB bytes"
    exit 1
fi
```

### 为什么需要限制？
- **硬件约束**：RK3308/RK1808 等芯片的固件分区大小是**固定的**（在 GPT 分区表中定义）
- **防止覆盖**：如果 u-boot.bin 超过分区大小，会无法写入或覆盖其他分区数据
- **提前检测**：避免生成无法烧录的镜像，节省调试时间

---

## 2. 传递给打包工具生成定长镜像

### 位置
- `uboot/make.sh:788` - 打包 U-Boot 镜像
- `uboot/make.sh:1079` - 打包 Trust 镜像

### 代码示例
```bash
# 打包 U-Boot 镜像（添加 Rockchip 头部）
${RKTOOLS}/loaderimage --pack --uboot ${OUTDIR}/u-boot.bin uboot.img \
    ${UBOOT_LOAD_ADDR} ${PLATFORM_UBOOT_IMG_SIZE}

# 打包 Trust 镜像（ARM64: ATF + OP-TEE）
${RKTOOLS}/trust_merger ${PLATFORM_SHA} ${PLATFORM_RSA} \
    ${PLATFORM_TRUST_IMG_SIZE} ${BIN_PATH_FIXUP} ${PACK_IGNORE_BL32} ${ini}
```

### --size 参数格式
- `--size 1024 2`：**1024KB** 总大小，**2** 个扇区（1 扇区 = 512 字节）
- `--size 512 2`：**512KB** 总大小（用于 AArch32 模式）

### 打包工具的处理逻辑
1. **填充对齐**：在原始二进制后填充 `0xFF`（Flash 擦除后的默认值）补齐到指定大小
2. **BootROM 兼容**：确保镜像可以被 BootROM 正确识别和加载到固定的内存地址
3. **性能优化**：保证分区对齐，避免性能损失或读取错误

---

## 3. 不同芯片的镜像尺寸配置

### 源码位置
`uboot/make.sh:621-636` 的 `fixup_platform_configure()` 函数

### 配置表

| 芯片型号 | 启动模式 | U-Boot 尺寸 | Trust 尺寸 | 说明 |
|---------|---------|------------|-----------|------|
| RK3308 | AArch32 | 512KB | 512KB | ARM64 以 32 位兼容模式启动，代码量更小 |
| RK3308 | ARM64 | 1024KB | 1024KB | 标准 ARM64 模式，需要完整 64 位代码 |
| RK1808 | ARM64 | 1024KB | 1024KB | NPU 芯片，固件复杂度更高 |
| 其他芯片 | - | 1022KB（默认） | - | 未明确配置的芯片使用默认值 |

### 配置代码
```bash
if [ $RKCHIP = "RK3308" ]; then
    # 如果 ARM64 以 AArch32 模式启动，使用较小的镜像尺寸
    if grep -q '^CONFIG_ARM64_BOOT_AARCH32=y' ${OUTDIR}/.config ; then
        PLATFORM_UBOOT_IMG_SIZE="--size 512 2"   # 512KB，2个扇区
        PLATFORM_TRUST_IMG_SIZE="--size 512 2"
    # 否则使用默认的 ARM64 镜像尺寸
    else
        PLATFORM_UBOOT_IMG_SIZE="--size 1024 2"  # 1MB，2个扇区
        PLATFORM_TRUST_IMG_SIZE="--size 1024 2"
    fi
elif [ $RKCHIP = "RK1808" ]; then
    # RK1808 固定使用 1MB 镜像尺寸
    PLATFORM_UBOOT_IMG_SIZE="--size 1024 2"
    PLATFORM_TRUST_IMG_SIZE="--size 1024 2"
fi
```

---

## 4. 为什么不同模式需要不同尺寸？

### AArch32 模式（512KB）
- **指令集更紧凑**：ARM32 指令（32 位）比 ARM64 指令（64 位）更小
- **库文件更小**：不需要 64 位宽的寄存器和数据结构
- **兼容性考虑**：用于需要兼容旧软件的场景

### ARM64 标准模式（1024KB）
- **代码量更大**：64 位指令、数据结构、库函数占用更多空间
- **功能更丰富**：支持更大内存寻址、更多寄存器、SIMD 扩展
- **性能更强**：充分利用 ARMv8 架构的高级特性

### RK1808 特殊配置（1024KB）
- **NPU 驱动**：需要额外的神经网络处理器初始化代码
- **多媒体加速**：集成更多硬件加速器的初始化逻辑
- **固件复杂度**：AI 芯片的启动流程比通用芯片更复杂

---

## 5. 镜像布局示例

以 RK3308 ARM64 模式为例，打包后的镜像结构：

```
+------------------------+
| Rockchip Header (2KB)  | ← Magic: 0x0FF0AA55, Chip ID, Load Addr, Size, CRC
+------------------------+
| U-Boot Binary          | ← 实际的 u-boot.bin 内容（例如 850KB）
+------------------------+
| Padding (0xFF)         | ← 填充到 1024KB - 2KB = 1022KB
+------------------------+
总计：1024KB (1MB)
```

### 为什么需要填充？
1. **BootROM 要求**：Rockchip BootROM 按固定大小读取镜像
2. **分区对齐**：Flash 设备通常以块（Block）为单位操作，对齐提升性能
3. **后续镜像定位**：Trust 镜像、Kernel 镜像的位置依赖于固定的 U-Boot 镜像大小

---

## 6. 相关文件位置

### 核心代码
- `uboot/make.sh:93-101` - 全局变量声明
- `uboot/make.sh:602-650` - `fixup_platform_configure()` 函数
- `uboot/make.sh:754-800` - `pack_uboot_image()` 函数（使用尺寸验证）
- `uboot/make.sh:1088-1143` - `pack_trust_image()` 函数（传递尺寸给工具）

### 打包工具
- `uboot/tools/rockchip/loaderimage.c:577` - loaderimage 工具源码
- `uboot/tools/rockchip/boot_merger.c` - Loader 合并工具
- `uboot/tools/rockchip/trust_merger.c:779` - Trust 合并工具

### 相关文档
- `uboot/固件打包原理深度解析.md` - 打包理论详解
- `uboot/docs/uboot镜像打包教程.md` - U-Boot 镜像打包指南
- `uboot/docs/trust镜像打包教程.md` - Trust 镜像打包指南

---

## 总结

**镜像尺寸参数的核心作用**：
1. ✅ **编译时验证**：确保二进制文件不超过硬件分区限制
2. ✅ **打包时填充**：生成固定大小的镜像，满足 BootROM 和分区对齐要求
3. ✅ **平台定制**：根据芯片型号和启动模式动态调整大小

**设计理念**：
- 在构建阶段就发现大小问题，而不是在烧录时失败
- 保证固件在所有 Rockchip 设备上都能正确启动
- 平衡固件功能与存储空间的限制


# --size 参数中的 "2" 是什么意思？

## 问题
在 `PLATFORM_UBOOT_IMG_SIZE="--size 1024 2"` 中，最后一个参数 `2` 是干什么用的？

---

## 答案：镜像副本数量

### 参数含义
```bash
--size 1024 2
       ^^^  ^
        |   |
        |   +--- 第二个参数：镜像副本数量 (max_num)
        +------- 第一个参数：单个镜像大小 KB (max_size)
```

### 源码证据

#### 1. 参数解析（loaderimage.c:155-169）
```c
} else if (!strcmp(argv[i], OPT_SIZE)) {
    in_size = strtoul(argv[++i], NULL, 10);  // 读取第一个参数：1024
    /*
     * Usually, it must be at 512kb align due to preloader
     * detects every 512kb. But some product has critial
     * flash size requirement, we have to make it small than
     * 512KB.
     */
    if (in_size % 64) {
        usage(argv[0]);
        exit(EXIT_FAILURE);
    }
    in_size *= 1024;  // 转换为字节数

    in_num = strtoul(argv[++i], NULL, 10);  // 读取第二个参数：2 ← 这就是副本数量！
}
```

#### 2. 配置镜像参数（loaderimage.c:185-205）
```c
if (image == IMAGE_UBOOT) {
    name = UBOOT_NAME;
    magic = RK_UBOOT_MAGIC;
    version = UBOOT_VERSION_STRING;
    max_size = in_size ? in_size : UBOOT_MAX_SIZE;  // 单个镜像大小
    max_num = in_num ? in_num : UBOOT_NUM;          // 副本数量 ← 从 in_num 来的
    loader_addr = (in_loader_addr == -1) ? RK_UBOOT_RUNNING_ADDR : in_loader_addr;
}
```

#### 3. 分配内存（loaderimage.c:208）
```c
buf = calloc(max_size, max_num);  // 分配 max_num 个 max_size 大小的内存块
```

#### 4. 写入文件（loaderimage.c:303-304）
```c
for (i = 0; i < max_num; i++)
    fwrite(buf, max_size, 1, fo);  // 循环写入 max_num 次，生成多个副本
```

---

## 为什么需要多个副本？

### 1. 冗余备份（Redundancy）
- **Flash 可靠性**：NAND Flash 可能会发生位翻转（Bit Flip）或坏块（Bad Block）
- **容错机制**：如果第一个副本损坏，BootROM 可以尝试读取第二个、第三个副本
- **提高启动成功率**：避免因单点故障导致设备变砖（Bricked）

### 2. BootROM 搜索机制
Rockchip BootROM 的镜像搜索流程：

```
BootROM 启动
    ↓
尝试读取第 1 个副本（偏移 0KB）
    ↓ 失败（CRC 错误、Magic 不匹配）
尝试读取第 2 个副本（偏移 1024KB）
    ↓ 失败
尝试读取第 3 个副本（偏移 2048KB）
    ↓ 成功
加载并跳转到 U-Boot
```

根据注释（loaderimage.c:158-162）：
> Usually, it must be at 512kb align due to preloader detects every 512kb.

**PreLoader（BootROM）每隔 512KB 搜索一次镜像**，所以：
- 1024KB 镜像 + 2 个副本 = 占用 2048KB（2MB）空间
- BootROM 会在 0KB、1024KB 位置尝试找到有效镜像

---

## 默认配置

### 源码定义（loaderimage.c:42-48）
```c
#ifdef CONFIG_RK_NVME_BOOT_EN
#define UBOOT_NUM 2              // NVMe 启动：2 个副本
#define UBOOT_MAX_SIZE 512 * 1024
#else
#define UBOOT_NUM 4              // 默认：4 个副本
#define UBOOT_MAX_SIZE 1024 * 1024
#endif
```

### Trust 镜像默认配置（loaderimage.c:57-59）
```c
#define TRUST_NAME "trustos"
#define TRUST_NUM 4              // Trust 默认也是 4 个副本
#define TRUST_MAX_SIZE 1024 * 1024
```

### 为什么 RK3308 使用 2 个副本？
查看 `uboot/make.sh:629`：
```bash
PLATFORM_UBOOT_IMG_SIZE="--size 1024 2"
```

**可能的原因**：
1. **存储空间限制**：RK3308 常用于 IoT 设备，Flash 容量较小
2. **启动速度优化**：减少副本数量可以减少 BootROM 搜索时间
3. **足够的冗余**：2 个副本已经提供基本的容错能力

---

## 镜像布局示例

### 配置：`--size 1024 2`

```
Flash 存储布局（uboot.img）：

+------------------------+  0KB
| 副本 1                  |
| ├─ Rockchip Header 2KB |
| └─ U-Boot Binary       |
+------------------------+  1024KB
| 副本 2                  |
| ├─ Rockchip Header 2KB |
| └─ U-Boot Binary       |
+------------------------+  2048KB
| 下一个分区（如 trust）   |
+------------------------+
```

### 配置：`--size 512 4`（默认值示例）

```
Flash 存储布局（假设使用默认 4 副本）：

+------------------------+  0KB
| 副本 1 (512KB)         |
+------------------------+  512KB
| 副本 2 (512KB)         |
+------------------------+  1024KB
| 副本 3 (512KB)         |
+------------------------+  1536KB
| 副本 4 (512KB)         |
+------------------------+  2048KB
| 下一个分区             |
+------------------------+
```

---

## 实际影响

### 1. 生成的镜像文件大小
```bash
# 单个镜像 1024KB × 2 个副本 = 2048KB (2MB)
ls -lh uboot.img
# 输出：2.0M uboot.img
```

### 2. Flash 分区占用
在 GPT 分区表中（参考 `scripts/lib/build_image.sh`）：
```
Partition 2 (uboot): 24576 扇区起，4MB 大小
  → 可以容纳 2 个 1024KB 副本（总共 2MB）
  → 剩余 2MB 空间预留或用于其他目的
```

### 3. 烧录时间
- 副本数量越多，烧录时间越长
- 副本数量越多，启动时的搜索时间可能越长（如果前面的副本都损坏）

---

## 相关代码位置

### 打包工具
- `uboot/tools/rockchip/loaderimage.c:155-169` - `--size` 参数解析
- `uboot/tools/rockchip/loaderimage.c:208` - 内存分配
- `uboot/tools/rockchip/loaderimage.c:303-304` - 多副本写入循环

### 调用代码
- `uboot/make.sh:788` - 调用 loaderimage 打包 uboot.img
- `uboot/make.sh:622-636` - 设置 PLATFORM_UBOOT_IMG_SIZE 和 PLATFORM_TRUST_IMG_SIZE

---

## 总结

| 参数 | 含义 | 作用 |
|-----|------|-----|
| `--size 1024` | 单个镜像大小 1024KB (1MB) | 限制单个副本的最大容量 |
| `--size ... 2` | 生成 2 个副本 | 提供冗余备份，增强启动可靠性 |

**核心目的**：通过多副本机制提升嵌入式设备的启动可靠性，避免因 Flash 损坏导致设备无法启动。

**权衡考虑**：
- ✅ **更多副本** → 更高可靠性，但占用更多存储空间
- ✅ **更少副本** → 节省空间，但容错能力下降

RK3308 选择 `2` 个副本是在可靠性和存储空间之间的合理平衡。
